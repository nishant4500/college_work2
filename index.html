<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Faculty Finder - Smart Timetable & Campus Map</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* --- Base / layout --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
            min-height: 100vh; color: #111; padding: 18px;
        }
        .container { max-width: 1400px; margin: 0 auto; }

        header { text-align:center; color:white; margin-bottom: 18px; position: relative; }
        h1 { font-size: 1.8rem; text-shadow: 2px 2px 4px rgba(0,0,0,0.2); }
        .subtitle { opacity: 0.95; margin-top: 6px; }

        /* Admin button */
        .admin-btn {
            position: absolute;
            top: 8px;
            right: 18px;
            background: rgba(255,255,255,0.18);
            color: white;
            border: 2px solid rgba(255,255,255,0.25);
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            backdrop-filter: blur(6px);
        }
        .admin-btn.logged-in { background: rgba(16,185,129,0.22); border-color:#10b981; }

        .demo-notice { background:#fff3cd; border:2px solid #ffc107; padding:10px; border-radius:8px; margin:10px 0; color:#856404; text-align:center; }

        .current-time-display {
            background: rgba(255,255,255,0.12); backdrop-filter: blur(6px); color: white;
            padding: 10px 14px; border-radius: 10px; margin: 10px 0 14px; text-align:center;
            font-size: 0.98em; font-weight:600;
        }

        .controls { display:flex; gap:12px; margin-bottom: 12px; align-items:center; flex-wrap:wrap; }
        .search-section { flex: 1; min-width: 220px; }
        .search-bar {
            width: 100%; padding: 12px 14px; font-size: 1.02em; border: 2px solid #e0e0e0; border-radius: 10px;
        }
        .filters { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
        select { padding:10px; border-radius:8px; border:2px solid #e0e0e0; min-width:160px; }

        .btn { background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:white; padding:10px 14px; border:none; border-radius:8px; cursor:pointer; font-size:0.95em; }
        .btn-secondary { background:#6c757d; }

        .stats { background: rgba(255,255,255,0.12); backdrop-filter: blur(6px); color: white; padding: 10px 14px; border-radius: 10px; margin-bottom: 14px; text-align:center; font-size: 0.95em; }

        .main-content { display:grid; grid-template-columns: 1fr 480px; gap:16px; align-items:start; }
        .results { display:grid; grid-template-columns: 1fr; gap:14px; }

        .faculty-card { background:white; padding:14px; border-radius:10px; box-shadow:0 6px 18px rgba(15,23,32,0.06); transition:transform .15s; }
        .faculty-card:hover { transform: translateY(-4px); }
        .faculty-card.highlighted { border:3px solid #fbbf24; box-shadow:0 0 20px rgba(251,191,36,0.35); }

        .faculty-name { font-size:1.05rem; font-weight:700; color:#667eea; margin-bottom:6px; }
        .faculty-info { margin-bottom:8px; color:#444; display:flex; gap:8px; flex-wrap:wrap; }
        .faculty-info strong { min-width:70px; color:#333; flex-shrink:0; }

        .smart-status { padding:10px; border-radius:8px; margin:8px 0; color:white; font-weight:700; display:flex; gap:10px; align-items:center; }
        .smart-status.available { background: linear-gradient(135deg,#10b981 0%,#059669 100%); }
        .smart-status.teaching { background: linear-gradient(135deg,#ef4444 0%,#dc2626 100%); }
        .smart-status.break { background: linear-gradient(135deg,#f59e0b 0%,#d97706 100%); }
        .smart-status.holiday { background: linear-gradient(135deg,#6b7280 0%,#374151 100%); }

        .next-available { background:#f3f4f6; padding:8px; border-radius:8px; margin-top:8px; border-left:4px solid #667eea; font-size:0.9em; }

        .department-tag { display:inline-block; padding:6px 10px; background:#f0f0f0; border-radius:20px; font-size:0.85em; color:#666; margin-top:8px; }
        .location-badge { display:inline-block; padding:6px 10px; background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:white; border-radius:20px; font-weight:600; margin-top:8px; float:right; }

        .timetable-preview { background:#f8f9fa; padding:10px; border-radius:8px; margin-top:10px; max-height:160px; overflow:auto; }
        .time-slot { display:flex; justify-content:space-between; padding:7px; margin:6px 0; background:white; border-radius:6px; font-size:0.88em; }
        .time-slot.current { background:#fef3c7; border:2px solid #f59e0b; font-weight:700; }

        .card-actions { display:flex; gap:8px; margin-top:10px; }
        .btn-directions { background:#667eea; color:white; border-radius:8px; padding:8px 10px; border:none; cursor:pointer; }
        .btn-appointment { background:#10b981; color:white; border-radius:8px; padding:8px 10px; border:none; cursor:pointer; }

        /* --- Map / cabins --- */
        .map-section { background:white; padding:16px; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,0.08); }
        .map-controls { display:flex; gap:10px; margin-bottom:12px; flex-wrap:wrap; }
        .floor-map { background:#f8f9fa; border-radius:10px; padding:10px; min-height:320px; position:relative; }
        .floor-title { font-weight:700; color:#333; text-align:center; margin-bottom:8px; }
        .cabin-grid { display:grid; grid-template-columns: repeat(3,1fr); gap:10px; padding:8px; }
        .cabin { background:white; border:2px solid #e0e0e0; border-radius:8px; padding:12px; cursor:pointer; text-align:center; transition:all .15s; }
        .cabin.occupied { background:#e8ebff; border-color:#667eea; }
        .cabin.vacant { background:#f5f5f5; border-color:#ccc; opacity:0.8; }
        .cabin.highlighted { background:#fef3c7; border:3px solid #fbbf24; box-shadow:0 0 14px rgba(251,191,36,0.25); }
        .cabin-number { font-weight:700; color:#333; margin-bottom:6px; }
        .cabin-faculty { font-size:0.9em; color:#666; }

        .legend { display:flex; gap:12px; justify-content:center; margin-top:10px; flex-wrap:wrap; }
        .legend-item { display:flex; gap:6px; align-items:center; color:#333; }
        .legend-box { width:16px; height:16px; border-radius:4px; }

        /* --- Modal --- */
        .modal { display:none; position:fixed; inset:0; background: rgba(0,0,0,0.6); z-index:1000; justify-content:center; align-items:center; padding:16px; }
        .modal.active { display:flex; }
        .modal-content { background:white; padding:18px; border-radius:10px; width:100%; max-width:720px; max-height:90vh; overflow:auto; }
        .modal-header { font-weight:700; color:#667eea; margin-bottom:8px; }

        .direction-step { display:flex; gap:12px; align-items:flex-start; background:#f8f9fa; padding:10px; border-radius:8px; margin-bottom:8px; border-left:4px solid #667eea; }
        .step-number { width:30px; height:30px; border-radius:50%; background:#667eea; color:white; font-weight:700; display:flex; align-items:center; justify-content:center; }

        .no-results { text-align:center; color:white; font-size:1.02em; padding:20px; background: rgba(255,255,255,0.08); border-radius:10px; }

        /* Upload/admin UI */
        .upload-section { display:none; background:white; padding:14px; border-radius:10px; margin-bottom:12px; box-shadow:0 8px 20px rgba(0,0,0,0.06); }
        .upload-section.visible { display:block; }
        .upload-area { border:2px dashed #667eea; border-radius:8px; padding:20px; text-align:center; cursor:pointer; background:#f8f9ff; margin-bottom:8px; }
        .upload-area.dragover { background:#eef2ff; transform:scale(1.01); }

        .holiday-pill { background:#6b7280;color:white;padding:6px 10px;border-radius:20px;font-weight:700;margin-left:6px; font-size:0.85em; }

        @media (max-width: 980px) {
            .main-content { grid-template-columns: 1fr; }
            .cabin-grid { grid-template-columns: repeat(2,1fr); }
            .admin-btn { position: static; margin: 12px auto 0; display: inline-block; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üéì Faculty Finder</h1>
            <div class="subtitle">Smart Timetable Integration ‚Ä¢ Find cabins, request appointments & get directions</div>
            <button id="adminBtn" class="admin-btn" aria-haspopup="true" aria-controls="adminModal">üîê Admin</button>
        </header>

        <div id="uploadSection" class="upload-section" aria-hidden="true">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                <div style="font-weight:700;color:#059669">üë®‚Äçüíº Admin Mode</div>
                <div>
                    <button id="logoutBtn" class="btn btn-secondary">Logout</button>
                </div>
            </div>

            <div id="uploadArea" class="upload-area" tabindex="0">
                <div style="font-size:1.6rem">üìÅ</div>
                <div style="font-weight:700;margin-top:8px">Click or drag & drop Excel (.xlsx/.xls)</div>
                <div style="font-size:0.9rem;color:#666;margin-top:6px">Columns accepted: Name, Building, Floor, Cabin, Department, Email, Phone, OfficeHours, Holiday</div>
                <input id="fileInput" type="file" accept=".xlsx,.xls" style="display:none">
            </div>

            <div style="display:flex;gap:8px;justify-content:flex-end;">
                <button id="chooseFileBtn" class="btn">Choose File</button>
                <button id="downloadTemplateBtn" class="btn btn-secondary">Download Template</button>
            </div>
        </div>

        <div class="demo-notice">üöÄ DEMO MODE ‚Äî Timetable-based status is evaluated in the browser local time. Use Admin to upload data or mark a faculty 'On Holiday'.</div>

        <div class="current-time-display" id="currentTime" aria-live="polite">Loading time...</div>

        <div class="stats" id="statsBar">
            Total: <strong id="totalCount">0</strong> |
            Available: <strong id="availableCount">0</strong> |
            Teaching: <strong id="teachingCount">0</strong> |
            Holiday: <strong id="holidayCount">0</strong>
        </div>

        <div class="controls">
            <div class="search-section">
                <input id="searchBar" class="search-bar" placeholder="Search by name, email or department..." aria-label="Search faculty" />
            </div>

            <div class="filters" style="flex:0 0 auto;">
                <select id="buildingFilter" title="Filter by building">
                    <option value="all">All Buildings</option>
                </select>
                <select id="departmentFilter" title="Filter by department">
                    <option value="all">All Departments</option>
                </select>
                <select id="floorFilter" title="Filter by floor">
                    <option value="all">All Floors</option>
                </select>
            </div>

            <div style="margin-left:auto; display:flex; gap:8px;">
                <button id="exportBtn" class="btn" title="Export visible list to Excel">Export</button>
                <button id="clearBtn" class="btn btn-secondary" title="Clear filters">Clear</button>
            </div>
        </div>

        <div class="main-content">
            <div>
                <div id="results" class="results" role="list"></div>
            </div>

            <aside class="map-section" aria-label="Interactive floor map area">
                <h3 style="color:#667eea; margin-bottom:8px;">üó∫Ô∏è Interactive Floor Map</h3>
                <div class="map-controls">
                    <select id="mapBuildingFilter" aria-label="Map building">
                        <option value="">Select Building</option>
                    </select>
                    <select id="mapFloorFilter" aria-label="Map floor">
                        <option value="">Select Floor</option>
                    </select>
                </div>

                <div id="floorMap" class="floor-map">
                    <div style="text-align:center; color:#999; padding:40px;">Select building & floor to view map</div>
                </div>

                <div class="legend" aria-hidden="false">
                    <div class="legend-item"><div class="legend-box occupied" style="background:#e8ebff;border:2px solid #667eea"></div><span>Occupied</span></div>
                    <div class="legend-item"><div class="legend-box vacant" style="background:#f5f5f5;border:2px solid #ccc"></div><span>Vacant</span></div>
                    <div class="legend-item"><div class="legend-box highlighted" style="background:#fef3c7;border:2px solid #fbbf24"></div><span>Selected</span></div>
                </div>
            </aside>
        </div>
    </div>

    <!-- Admin Login Modal (hidden until needed) -->
    <div id="adminModal" class="modal" aria-hidden="true">
        <div class="modal-content" role="dialog" aria-modal="true">
            <div class="modal-header">üîê Admin Login</div>
            <div style="margin-bottom:8px">
                <label style="display:block;font-weight:700;margin-bottom:6px">Username</label>
                <input id="adminUser" type="text" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px" />
            </div>
            <div style="margin-bottom:8px">
                <label style="display:block;font-weight:700;margin-bottom:6px">Password</label>
                <input id="adminPass" type="password" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px" />
            </div>
            <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
                <button id="adminLoginBtn" class="btn">Login</button>
                <button class="btn btn-secondary" onclick="closeAdminModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Directions Modal (reused) -->
    <div id="directionsModal" class="modal" aria-hidden="true">
        <div class="modal-content" role="dialog" aria-modal="true">
            <div class="modal-header">üß≠ Navigation Directions</div>
            <div id="directionsContent"></div>
            <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
                <button class="btn btn-secondary" onclick="closeDirectionsModal()">Close</button>
            </div>
        </div>
    </div>

    <script>
        // ------------------ Admin settings & persistence ------------------
        const ADMIN_USERNAME = 'admin';
        const ADMIN_PASSWORD = 'admin123';
        let isAdminLoggedIn = false;

        // Try to load persisted data & admin state
        const persisted = localStorage.getItem('facultyData_v1');
        if (persisted) {
            try {
                const parsed = JSON.parse(persisted);
                if (Array.isArray(parsed)) facultyData = parsed;
            } catch (e) {
                // ignore parse errors, will use built-in sample
            }
        }
        const adminState = localStorage.getItem('faculty_admin_logged_in');
        if (adminState === 'true') {
            isAdminLoggedIn = true;
        }

        // ------------------ Faculty data (sample) ------------------
        // If facultyData not defined by persistence, set sample dataset
       

        // If persistence didn't supply data, use the embedded sample set (same as before)
    
            facultyData = [
                {
                    name: "Dr. Vikram Karwal",
                    building: "ABB1",
                    cabin: "201",
                    floor: "2",
                    department: "Electronics and Communication Engineering",
                    email: "vikram.karwal@jiit.ac.in",
                    phone: "9717652233",
                    officeHours: "Mon-Fri 10AM-5PM",
                    // holiday: false,
                    timetable: { /* same timetable objects as earlier omitted for brevity */ 
                        Monday: [
                            { time: "09:00-10:00", subject: "Digital Electronics", room: "Room 301" },
                            { time: "10:00-11:00", subject: "Free", room: "Cabin 201" },
                            { time: "11:00-12:00", subject: "Signal Processing", room: "Room 305" },
                            { time: "12:00-13:00", subject: "Free", room: "Cabin 201" },
                            { time: "14:00-15:00", subject: "Lab Session", room: "Lab 101" },
                            { time: "15:00-16:00", subject: "Free", room: "Cabin 201" }
                        ],
                        Tuesday: [
                            { time: "09:00-10:00", subject: "Free", room: "Cabin 201" },
                            { time: "10:00-11:00", subject: "Digital Electronics", room: "Room 301" },
                            { time: "11:00-12:00", subject: "Free", room: "Cabin 201" },
                            { time: "14:00-15:00", subject: "Signal Processing", room: "Room 305" },
                            { time: "15:00-16:00", subject: "Free", room: "Cabin 201" }
                        ],
                        Wednesday: [
                            { time: "09:00-10:00", subject: "Digital Electronics", room: "Room 301" },
                            { time: "10:00-11:00", subject: "Free", room: "Cabin 201" },
                            { time: "11:00-12:00", subject: "Signal Processing", room: "Room 305" },
                            { time: "14:00-15:00", subject: "Free", room: "Cabin 201" }
                        ],
                        Thursday: [
                            { time: "10:00-11:00", subject: "Digital Electronics", room: "Room 301" },
                            { time: "11:00-12:00", subject: "Free", room: "Cabin 201" },
                            { time: "14:00-15:00", subject: "Lab Session", room: "Lab 101" },
                            { time: "15:00-16:00", subject: "Free", room: "Cabin 201" }
                        ],
                        Friday: [
                            { time: "09:00-10:00", subject: "Free", room: "Cabin 201" },
                            { time: "10:00-11:00", subject: "Signal Processing", room: "Room 305" },
                            { time: "11:00-12:00", subject: "Free", room: "Cabin 201" },
                            { time: "14:00-15:00", subject: "Faculty Meeting", room: "Conference Room" }
                        ]
                    }
                },
                {
                    name: "Prof. Jasmine Saini",
                    building: "ABB2",
                    cabin: "301",
                    floor: "3",
                    department: "Electronics and Communication Engineering",
                    email: "jasmine.saini@jiit.ac.in",
                    phone: "9871005331",
                    officeHours: "Tue-Thu 2PM-6PM",
                    timetable: {
                        Monday: [
                            { time: "09:00-10:00", subject: "Communication Systems", room: "Room 201" },
                            { time: "10:00-11:00", subject: "Free", room: "Cabin 301" },
                            { time: "11:00-12:00", subject: "Microwave Engineering", room: "Room 203" },
                            { time: "14:00-15:00", subject: "Free", room: "Cabin 301" },
                            { time: "15:00-16:00", subject: "Lab Session", room: "Lab 102" }
                        ],
                        Tuesday: [
                            { time: "10:00-11:00", subject: "Communication Systems", room: "Room 201" },
                            { time: "11:00-12:00", subject: "Free", room: "Cabin 301" },
                            { time: "14:00-15:00", subject: "Microwave Engineering", room: "Room 203" },
                            { time: "15:00-16:00", subject: "Free", room: "Cabin 301" }
                        ],
                        Wednesday: [
                            { time: "09:00-10:00", subject: "Free", room: "Cabin 301" },
                            { time: "10:00-11:00", subject: "Communication Systems", room: "Room 201" },
                            { time: "11:00-12:00", subject: "Free", room: "Cabin 301" },
                            { time: "14:00-15:00", subject: "Lab Session", room: "Lab 102" }
                        ],
                        Thursday: [
                            { time: "09:00-10:00", subject: "Microwave Engineering", room: "Room 203" },
                            { time: "10:00-11:00", subject: "Free", room: "Cabin 301" },
                            { time: "11:00-12:00", subject: "Communication Systems", room: "Room 201" },
                            { time: "14:00-15:00", subject: "Free", room: "Cabin 301" }
                        ],
                        Friday: [
                            { time: "10:00-11:00", subject: "Free", room: "Cabin 301" },
                            { time: "11:00-12:00", subject: "Microwave Engineering", room: "Room 203" },
                            { time: "14:00-15:00", subject: "Free", room: "Cabin 301" }
                        ]
                    }
                },
                {
                    name: "Dr. Alka Tripathi",
                    building: "ABB1",
                    cabin: "205",
                    floor: "2",
                    department: "Mathematics",
                    email: "alka.choubey@jiit.ac.in",
                    phone: "9876543210",
                    officeHours: "Mon-Wed-Fri 11AM-4PM",
                    timetable: {
                        Monday: [
                            { time: "09:00-10:00", subject: "Calculus", room: "Room 401" },
                            { time: "10:00-11:00", subject: "Free", room: "Cabin 205" },
                            { time: "11:00-12:00", subject: "Linear Algebra", room: "Room 402" },
                            { time: "14:00-15:00", subject: "Free", room: "Cabin 205" }
                        ],
                        Tuesday: [
                            { time: "10:00-11:00", subject: "Calculus", room: "Room 401" },
                            { time: "11:00-12:00", subject: "Free", room: "Cabin 205" },
                            { time: "14:00-15:00", subject: "Linear Algebra", room: "Room 402" },
                            { time: "15:00-16:00", subject: "Free", room: "Cabin 205" }
                        ],
                        Wednesday: [
                            { time: "09:00-10:00", subject: "Free", room: "Cabin 205" },
                            { time: "10:00-11:00", subject: "Calculus", room: "Room 401" },
                            { time: "11:00-12:00", subject: "Free", room: "Cabin 205" }
                        ],
                        Thursday: [
                            { time: "09:00-10:00", subject: "Linear Algebra", room: "Room 402" },
                            { time: "10:00-11:00", subject: "Free", room: "Cabin 205" },
                            { time: "11:00-12:00", subject: "Calculus", room: "Room 401" },
                            { time: "14:00-15:00", subject: "Free", room: "Cabin 205" }
                        ],
                        Friday: [
                            { time: "10:00-11:00", subject: "Free", room: "Cabin 205" },
                            { time: "11:00-12:00", subject: "Linear Algebra", room: "Room 402" },
                            { time: "14:00-15:00", subject: "Free", room: "Cabin 205" }
                        ]
                    }
                },
                {
                    name: "Prof. Amit Srivastava",
                    building: "ABB3",
                    cabin: "110",
                    floor: "1",
                    department: "Mathematics",
                    email: "amit.srivastava@jiit.ac.in",
                    phone: "9876543216",
                    officeHours: "Mon-Fri 9AM-3PM",
                    timetable: {
                        Monday: [
                            { time: "09:00-10:00", subject: "Probability", room: "Room 501" },
                            { time: "10:00-11:00", subject: "Free", room: "Cabin 110" },
                            { time: "11:00-12:00", subject: "Statistics", room: "Room 502" },
                            { time: "14:00-15:00", subject: "Free", room: "Cabin 110" }
                        ],
                        Tuesday: [
                            { time: "10:00-11:00", subject: "Probability", room: "Room 501" },
                            { time: "11:00-12:00", subject: "Free", room: "Cabin 110" },
                            { time: "14:00-15:00", subject: "Statistics", room: "Room 502" }
                        ],
                        Wednesday: [
                            { time: "09:00-10:00", subject: "Free", room: "Cabin 110" },
                            { time: "10:00-11:00", subject: "Probability", room: "Room 501" },
                            { time: "14:00-15:00", subject: "Free", room: "Cabin 110" }
                        ],
                        Thursday: [
                            { time: "09:00-10:00", subject: "Statistics", room: "Room 502" },
                            { time: "10:00-11:00", subject: "Free", room: "Cabin 110" },
                            { time: "11:00-12:00", subject: "Probability", room: "Room 501" }
                        ],
                        Friday: [
                            { time: "10:00-11:00", subject: "Free", room: "Cabin 110" },
                            { time: "11:00-12:00", subject: "Statistics", room: "Room 502" },
                            { time: "14:00-15:00", subject: "Free", room: "Cabin 110" }
                        ]
                    }
                },
                {
                    name: "Dr. Gaurav Verma",
                    building: "ABB2",
                    cabin: "305",
                    floor: "3",
                    department: "Computer Science",
                    email: "gaurav.verma@jiit.ac.in",
                    phone: "9811506739",
                    officeHours: "Daily 10AM-6PM",
                    timetable: {
                        Monday: [
                            { time: "09:00-10:00", subject: "Data Structures", room: "Room 101" },
                            { time: "10:00-11:00", subject: "Free", room: "Cabin 305" },
                            { time: "11:00-12:00", subject: "Algorithms", room: "Room 102" },
                            { time: "14:00-15:00", subject: "Free", room: "Cabin 305" },
                            { time: "15:00-16:00", subject: "Programming Lab", room: "Lab 201" }
                        ],
                        Tuesday: [
                            { time: "10:00-11:00", subject: "Data Structures", room: "Room 101" },
                            { time: "11:00-12:00", subject: "Free", room: "Cabin 305" },
                            { time: "14:00-15:00", subject: "Algorithms", room: "Room 102" },
                            { time: "15:00-16:00", subject: "Free", room: "Cabin 305" }
                        ],
                        Wednesday: [
                            { time: "09:00-10:00", subject: "Free", room: "Cabin 305" },
                            { time: "10:00-11:00", subject: "Data Structures", room: "Room 101" },
                            { time: "11:00-12:00", subject: "Free", room: "Cabin 305" },
                            { time: "14:00-15:00", subject: "Programming Lab", room: "Lab 201" }
                        ],
                        Thursday: [
                            { time: "09:00-10:00", subject: "Algorithms", room: "Room 102" },
                            { time: "10:00-11:00", subject: "Free", room: "Cabin 305" },
                            { time: "11:00-12:00", subject: "Data Structures", room: "Room 101" },
                            { time: "14:00-15:00", subject: "Free", room: "Cabin 305" }
                        ],
                        Friday: [
                            { time: "10:00-11:00", subject: "Free", room: "Cabin 305" },
                            { time: "11:00-12:00", subject: "Algorithms", room: "Room 102" },
                            { time: "14:00-15:00", subject: "Free", room: "Cabin 305" }
                        ]
                    }
                }
            ];
        

        // ------------------ Time helpers ------------------
        function getNow() { return new Date(); }
        function getDayNameFromDate(d) {
            const days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
            return days[d.getDay()];
        }
        function formatNowForDisplay(now) {
            const options = { weekday:'long', year:'numeric', month:'short', day:'numeric', hour:'2-digit', minute:'2-digit', second:'2-digit', timeZoneName:'short' };
            return `üìÖ ${now.toLocaleString('en-US', options)}`;
        }
        function parseTimeToMinutes(timeStr) {
            const [h,m] = timeStr.split(':').map(Number);
            return h*60 + m;
        }
        function isWithinTimeSlot(timeRange, now) {
            const [start, end] = timeRange.split('-');
            const startMin = parseTimeToMinutes(start);
            const endMin = parseTimeToMinutes(end);
            const curMin = now.getHours()*60 + now.getMinutes();
            return curMin >= startMin && curMin < endMin;
        }

        // ------------------ Core status (now includes holiday check) ------------------
        function getFacultyStatusAt(faculty, now) {
            // Manual holiday flag takes precedence
            if (faculty.holiday) {
                return {
                    status: 'holiday',
                    message: 'On Leave',
                    location: faculty.cabin ? `${faculty.building} - Cabin ${faculty.cabin}` : 'N/A',
                    nextAvailable: 'Not available (On Leave)'
                };
            }

            const day = getDayNameFromDate(now);
            if (!faculty.timetable || !faculty.timetable[day] || faculty.timetable[day].length === 0) {
                return {
                    status: (day === 'Saturday' || day === 'Sunday') ? 'break' : 'away',
                    message: (day === 'Saturday' || day === 'Sunday') ? 'Weekend ‚Äî No classes' : 'No schedule for today',
                    location: faculty.cabin ? `${faculty.building} - Cabin ${faculty.cabin}` : 'Unknown',
                    nextAvailable: 'Check schedule'
                };
            }

            const todaySchedule = faculty.timetable[day];
            let currentSlot = null;
            let nextFreeSlot = null;
            const curTotal = now.getHours()*60 + now.getMinutes();

            for (const slot of todaySchedule) {
                if (isWithinTimeSlot(slot.time, now)) {
                    currentSlot = slot;
                    break;
                }
            }

            for (const slot of todaySchedule) {
                const [startTime] = slot.time.split('-');
                const slotTotal = parseTimeToMinutes(startTime);
                if (slotTotal > curTotal && slot.subject.toLowerCase() === 'free') {
                    nextFreeSlot = slot;
                    break;
                }
            }

            if (!currentSlot) {
                return {
                    status: 'away',
                    message: 'Currently not in cabin',
                    location: faculty.cabin ? `${faculty.building} - Cabin ${faculty.cabin}` : 'Away',
                    nextAvailable: nextFreeSlot ? `Next available: ${nextFreeSlot.time}` : 'Check schedule for availability'
                };
            }

            if (currentSlot.subject.toLowerCase() === 'free') {
                return {
                    status: 'available',
                    message: `Available in ${currentSlot.room}`,
                    location: currentSlot.room,
                    nextAvailable: 'Available now!',
                    currentSlot
                };
            } else {
                return {
                    status: 'teaching',
                    message: `Teaching ${currentSlot.subject}`,
                    location: currentSlot.room,
                    nextAvailable: nextFreeSlot ? `Free after this at ${nextFreeSlot.time}` : 'Check schedule for next availability',
                    currentSlot
                };
            }
        }

        // ------------------ DOM elements ------------------
        const searchBar = document.getElementById('searchBar');
        const resultsContainer = document.getElementById('results');
        const totalCountEl = document.getElementById('totalCount');
        const availableCountEl = document.getElementById('availableCount');
        const teachingCountEl = document.getElementById('teachingCount');
        const holidayCountEl = document.getElementById('holidayCount');
        const currentTimeEl = document.getElementById('currentTime');

        const buildingFilter = document.getElementById('buildingFilter');
        const departmentFilter = document.getElementById('departmentFilter');
        const floorFilter = document.getElementById('floorFilter');

        const exportBtn = document.getElementById('exportBtn');
        const clearBtn = document.getElementById('clearBtn');

        const mapBuildingFilter = document.getElementById('mapBuildingFilter');
        const mapFloorFilter = document.getElementById('mapFloorFilter');
        const floorMapDiv = document.getElementById('floorMap');

        const adminBtn = document.getElementById('adminBtn');
        const adminModal = document.getElementById('adminModal');
        const adminUser = document.getElementById('adminUser');
        const adminPass = document.getElementById('adminPass');
        const adminLoginBtn = document.getElementById('adminLoginBtn');
        const uploadSection = document.getElementById('uploadSection');
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const chooseFileBtn = document.getElementById('chooseFileBtn');
        const downloadTemplateBtn = document.getElementById('downloadTemplateBtn');
        const logoutBtn = document.getElementById('logoutBtn');

        const directionsModal = document.getElementById('directionsModal');
        const directionsContent = document.getElementById('directionsContent');

        // ------------------ Utilities ------------------
        function debounce(fn, wait=180) { let t; return (...args) => { clearTimeout(t); t = setTimeout(()=>fn(...args), wait); }; }

        // ------------------ Filters / search logic ------------------
        function updateFilters() {
            const buildings = [...new Set(facultyData.map(f => f.building).filter(Boolean))].sort();
            const departments = [...new Set(facultyData.map(f => f.department).filter(Boolean))].sort();
            const floors = [...new Set(facultyData.map(f => f.floor).filter(Boolean))].sort();

            buildingFilter.innerHTML = '<option value="all">All Buildings</option>';
            mapBuildingFilter.innerHTML = '<option value="">Select Building</option>';
            buildings.forEach(b => {
                const opt = document.createElement('option'); opt.value = b; opt.textContent = b; buildingFilter.appendChild(opt);
                const opt2 = document.createElement('option'); opt2.value = b; opt2.textContent = b; mapBuildingFilter.appendChild(opt2);
            });

            departmentFilter.innerHTML = '<option value="all">All Departments</option>';
            departments.forEach(d => { const o = document.createElement('option'); o.value=d; o.textContent=d; departmentFilter.appendChild(o); });

            floorFilter.innerHTML = '<option value="all">All Floors</option>';
            mapFloorFilter.innerHTML = '<option value="">Select Floor</option>';
            floors.forEach(fl => {
                const o = document.createElement('option'); o.value=fl; o.textContent=`Floor ${fl}`; floorFilter.appendChild(o);
                const o2 = document.createElement('option'); o2.value=fl; o2.textContent=`Floor ${fl}`; mapFloorFilter.appendChild(o2);
            });
        }

        function getFilteredFacultyList(term = '') {
            const searchTerm = (term || '').trim().toLowerCase();
            const b = buildingFilter.value;
            const d = departmentFilter.value;
            const fl = floorFilter.value;
            return facultyData.filter(f => {
                const matchesSearch = !searchTerm || (f.name && f.name.toLowerCase().includes(searchTerm))
                    || (f.email && f.email.toLowerCase().includes(searchTerm))
                    || (f.department && f.department.toLowerCase().includes(searchTerm))
                    || (f.phone && f.phone.includes(searchTerm));
                const matchesBuilding = (b === 'all' || b === '' ) ? true : f.building === b;
                const matchesDept = (d === 'all' || d === '') ? true : f.department === d;
                const matchesFloor = (fl === 'all' || fl === '') ? true : String(f.floor) === String(fl);
                return matchesSearch && matchesBuilding && matchesDept && matchesFloor;
            });
        }

        // ------------------ Rendering faculty cards ------------------
        function displayFaculty(list, now = getNow()) {
            resultsContainer.innerHTML = '';
            if (!list || list.length === 0) {
                resultsContainer.innerHTML = '<div class="no-results">No faculty found. Adjust search/filters.</div>';
                return;
            }

            list.forEach((faculty, idx) => {
                const status = getFacultyStatusAt(faculty, now);
                const day = getDayNameFromDate(now);
                const todaySchedule = faculty.timetable?.[day] || [];

                const card = document.createElement('div');
                card.className = 'faculty-card';
                if (selectedFaculty && selectedFaculty.email === faculty.email) card.classList.add('highlighted');
                card.setAttribute('role','listitem');

                const statusClass = status.status === 'available' ? 'available' : (status.status === 'teaching' ? 'teaching' : (status.status === 'holiday' ? 'holiday' : 'break'));
                const statusIcon = status.status === 'available' ? '‚úÖ' : (status.status === 'teaching' ? 'üìö' : (status.status === 'holiday' ? 'üèñÔ∏è' : '‚è∞'));

                // timetable preview
                let timetableHTML = '';
                if (todaySchedule.length) {
                    timetableHTML = `<div class="timetable-preview"><h4 style="color:#667eea;margin:0 0 8px 0;font-size:0.95em">üìÖ Today's Schedule (${day})</h4>` +
                        todaySchedule.map(slot => `<div class="time-slot ${status.currentSlot && slot.time === status.currentSlot.time ? 'current' : ''}"><span>${slot.time}</span><span style="opacity:.9">${slot.subject} - ${slot.room}</span></div>`).join('') +
                        `</div>`;
                }

                // show holiday pill for quick visual
                const holidayPill = faculty.holiday ? `<span class="holiday-pill" title="Marked On Leave">On Leave</span>` : '';

                card.innerHTML = `
                    <div style="display:flex;justify-content:space-between;align-items:center">
                        <div class="faculty-name">${faculty.name}</div>
                        ${holidayPill}
                    </div>
                    <div class="faculty-info"><strong>Email:</strong><a href="mailto:${faculty.email}" style="color:#667eea;text-decoration:none">${faculty.email}</a></div>
                    ${faculty.phone ? `<div class="faculty-info"><strong>Phone:</strong><a href="tel:+91${faculty.phone}" style="color:#667eea;text-decoration:none">+91 ${faculty.phone}</a></div>` : ''}
                    <div class="smart-status ${statusClass}"><span style="font-size:1.1em">${statusIcon}</span><div><strong style="display:block">${status.message}</strong><div style="font-size:.9em;margin-top:4px">üìç ${status.location}</div></div></div>
                    <div class="next-available"><strong>‚è∞ Next Available:</strong> ${status.nextAvailable}</div>
                    <div style="margin-top:8px;">
                        <span class="department-tag">${faculty.department}</span>
                        ${faculty.building ? `<span class="location-badge">üè¢ ${faculty.building} - Floor ${faculty.floor} - Cabin ${faculty.cabin}</span>` : ''}
                    </div>
                    ${timetableHTML}
                    <div class="card-actions">
                        <button class="btn-directions" data-index="${idx}" aria-label="Directions for ${faculty.name}">üß≠ Directions</button>
                        <button class="btn-appointment" data-index="${idx}" aria-label="Request appointment with ${faculty.name}">üìÖ Appointment</button>
                        <button class="btn view-schedule" data-index="${idx}" style="background:#5568d3;color:white;border-radius:8px;padding:8px 10px;border:none;cursor:pointer">üìã Full Week</button>
                        ${isAdminLoggedIn ? `<button class="btn btn-secondary toggle-holiday" data-email="${faculty.email}" data-holiday="${faculty.holiday ? '1' : '0'}" style="min-width:120px">${faculty.holiday ? 'Unmark Holiday' : 'Mark On Holiday'}</button>` : ''}
                    </div>
                `;

                // clicking card (not targeting a button) highlights and focuses map
                card.addEventListener('click', (e) => {
                    if (!e.target.closest('button') && !e.target.closest('a')) {
                        highlightFacultyByIndex(idx);
                    }
                });

                resultsContainer.appendChild(card);
            });
        }

        // ------------------ Highlight / select faculty ------------------
        let selectedFaculty = null;
        function highlightFacultyByIndex(idx) {
            const filtered = getFilteredFacultyList(searchBar.value);
            const f = filtered[idx];
            if (!f) return;
            selectedFaculty = facultyData.find(x => x.email === f.email) || f;
            if (selectedFaculty.building) mapBuildingFilter.value = selectedFaculty.building;
            if (selectedFaculty.floor) mapFloorFilter.value = selectedFaculty.floor;
            updateMap();
            const now = getNow();
            displayFaculty(getFilteredFacultyList(searchBar.value), now);
        }

        // ------------------ Full schedule modal ------------------
        function showFullScheduleByIndexFromFiltered(idx) {
            const filtered = getFilteredFacultyList(searchBar.value);
            const faculty = filtered[idx];
            if (!faculty) return;
            const days = ['Monday','Tuesday','Wednesday','Thursday','Friday'];
            let scheduleHTML = `<div style="max-height:60vh;overflow:auto"><h3 style="color:#667eea;margin-bottom:10px">${faculty.name}'s Weekly Schedule</h3>`;
            days.forEach(day=>{
                if (faculty.timetable?.[day]?.length) {
                    scheduleHTML += `<div style="margin-bottom:12px"><h4 style="margin:6px 0;color:#333">${day}</h4>`;
                    scheduleHTML += faculty.timetable[day].map(slot=>`<div class="time-slot" style="margin-bottom:6px"><span>${slot.time}</span><span>${slot.subject} - ${slot.room}</span></div>`).join('');
                    scheduleHTML += `</div>`;
                }
            });
            scheduleHTML += `</div><div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px"><button class="btn btn-secondary" onclick="closeModalByElement(this)">Close</button></div>`;
            openModalWithHTML(scheduleHTML, 'Weekly Schedule');
        }

        function openModalWithHTML(innerHTML, title='') {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `<div class="modal-content" role="dialog" aria-modal="true">
                <div class="modal-header">${title}</div>
                <div>${innerHTML}</div>
            </div>`;
            document.body.appendChild(modal);
            modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });
            const onKey = (ev) => { if (ev.key === 'Escape') { modal.remove(); window.removeEventListener('keydown', onKey); } };
            window.addEventListener('keydown', onKey);
        }
        function closeModalByElement(button) { button.closest('.modal')?.remove(); }

        // ------------------ Directions ------------------
        function showDirectionsByIndexFromFiltered(idx) {
            const filtered = getFilteredFacultyList(searchBar.value);
            const faculty = filtered[idx];
            if (!faculty) return showMessage('No faculty selected for directions', 'error');

            const building = faculty.building || 'Building';
            const floor = faculty.floor || 'floor';
            const cabin = faculty.cabin || 'cabin';

            const cabinNumDigits = cabin ? cabin.replace(/\D/g,'') : '';
            const lateral = (cabinNumDigits && parseInt(cabinNumDigits,10) <= 110) ? 'left' : 'right';
            const steps = [
                `Enter <strong>${building}</strong> from the main entrance.`,
                floor === '1' ? 'Proceed along the ground floor corridor.' : `Take the stairs or elevator to <strong>Floor ${floor}</strong>.`,
                floor === '1' ? 'Walk straight to the cabin area.' : 'Exit the elevator/stairs and follow the corridor.',
                `Look for <strong>Cabin ${cabin}</strong> on your <strong>${lateral}</strong>.`,
                `You have arrived at <strong>${faculty.name}'s</strong> cabin.`
            ];

            directionsContent.innerHTML = steps.map((s,i)=>`<div class="direction-step"><div class="step-number">${i+1}</div><div class="step-text">${s}</div></div>`).join('');
            directionsModal.classList.add('active');
            directionsModal.setAttribute('aria-hidden','false');
        }
        function closeDirectionsModal() {
            directionsModal.classList.remove('active');
            directionsModal.setAttribute('aria-hidden','true');
        }

        // ------------------ Appointment (mailto) ------------------
        function requestAppointmentByIndexFromFiltered(idx) {
            const filtered = getFilteredFacultyList(searchBar.value);
            const faculty = filtered[idx];
            if (!faculty) return showMessage('No faculty selected for appointment','error');

            const subject = encodeURIComponent(`Appointment Request - ${faculty.name}`);
            const body = encodeURIComponent(`Dear ${faculty.name},%0D%0A%0D%0AI would like to request an appointment with you.%0D%0A%0D%0AMy Name: [Your Name]%0D%0AStudent ID: [Your ID]%0D%0APurpose: [Reason for meeting]%0D%0APreferred Date/Time: [Your availability]%0D%0A%0D%0AThank you.%0D%0A`);
            window.location.href = `mailto:${faculty.email}?subject=${subject}&body=${body}`;
        }

        // ------------------ Update map ------------------
        function updateMap() {
            const building = mapBuildingFilter.value;
            const floor = mapFloorFilter.value;
            if (!building || !floor) {
                floorMapDiv.innerHTML = `<div style="text-align:center;color:#999;padding:40px">Select a building and floor to view the map</div>`;
                return;
            }

            const cabins = facultyData.filter(f => f.building === building && String(f.floor) === String(floor));
            const cabinCodes = [...new Set(cabins.map(c => c.cabin).filter(Boolean))].sort();

            let html = `<div class="floor-title">${building} - Floor ${floor}</div>`;
            html += '<div class="cabin-grid">';
            if (cabinCodes.length === 0) {
                for (let i=1;i<=12;i++){
                    const num = String(i).padStart(2,'0');
                    const cabinId = `${floor}${num}`;
                    html += `<div class="cabin vacant" data-cabin="${cabinId}"><div class="cabin-number">${cabinId}</div><div class="cabin-faculty">Vacant</div></div>`;
                }
            } else {
                cabinCodes.forEach(code=>{
                    const faculty = cabins.find(c=>c.cabin === code);
                    const isHighlighted = selectedFaculty && selectedFaculty.cabin === code && selectedFaculty.building === building;
                    if (faculty) {
                        const cls = isHighlighted ? 'occupied highlighted' : 'occupied';
                        html += `<div class="cabin ${cls}" data-email="${faculty.email}">
                                    <div class="cabin-number">${code}</div>
                                    <div class="cabin-faculty">${faculty.name.split(' ').slice(-1)[0]}</div>
                                    <div class="cabin-dept" style="font-size:.8em;color:#999">${(faculty.department||'').slice(0,18)}</div>
                                 </div>`;
                    } else {
                        html += `<div class="cabin vacant" data-cabin="${code}"><div class="cabin-number">${code}</div><div class="cabin-faculty">Vacant</div></div>`;
                    }
                });
            }
            html += '</div>';
            floorMapDiv.innerHTML = html;

            floorMapDiv.querySelectorAll('.cabin.occupied').forEach(el=>{
                el.addEventListener('click', () => {
                    const email = el.getAttribute('data-email');
                    const fac = facultyData.find(f=>f.email === email);
                    if (fac) {
                        selectedFaculty = fac;
                        buildingFilter.value = fac.building || 'all';
                        departmentFilter.value = fac.department || 'all';
                        floorFilter.value = fac.floor || 'all';
                        displayFaculty( getFilteredFacultyList(searchBar.value), getNow() );
                    }
                });
            });
        }

        // ------------------ Export visible to Excel (includes Holiday) ------------------
        function exportVisibleToExcel() {
            const list = getFilteredFacultyList(searchBar.value);
            if (!list.length) return alert('No rows to export.');
            const rows = list.map(f => ({
                Name: f.name,
                Department: f.department,
                Email: f.email,
                Phone: f.phone || '',
                Building: f.building || '',
                Floor: f.floor || '',
                Cabin: f.cabin || '',
                OfficeHours: f.officeHours || '',
                Holiday: f.holiday ? 'Yes' : 'No'
            }));
            const ws = XLSX.utils.json_to_sheet(rows);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Faculty');
            XLSX.writeFile(wb, `faculty_export_${new Date().toISOString().slice(0,10)}.xlsx`);
        }

        // ------------------ UI message helper ------------------
        function showMessage(text, type='success') {
            const el = document.createElement('div');
            el.textContent = text;
            el.style.position = 'fixed';
            el.style.right = '18px';
            el.style.bottom = '18px';
            el.style.background = type==='success' ? '#10b981' : '#ef4444';
            el.style.color = 'white';
            el.style.padding = '10px 14px';
            el.style.borderRadius = '8px';
            el.style.boxShadow = '0 8px 24px rgba(0,0,0,0.15)';
            document.body.appendChild(el);
            setTimeout(()=>el.remove(), 4000);
        }

        // ------------------ Event delegation for result buttons ------------------
        resultsContainer.addEventListener('click', (e) => {
            const viewBtn = e.target.closest('.view-schedule');
            if (viewBtn) {
                const idx = Number(viewBtn.dataset.index);
                showFullScheduleByIndexFromFiltered(idx);
                return;
            }
            const dirBtn = e.target.closest('.btn-directions');
            if (dirBtn) {
                const idx = Number(dirBtn.dataset.index);
                showDirectionsByIndexFromFiltered(idx);
                return;
            }
            const appBtn = e.target.closest('.btn-appointment');
            if (appBtn) {
                const idx = Number(appBtn.dataset.index);
                requestAppointmentByIndexFromFiltered(idx);
                return;
            }
            const holidayBtn = e.target.closest('.toggle-holiday');
            if (holidayBtn) {
                const email = holidayBtn.dataset.email;
                toggleHolidayByEmail(email);
                return;
            }
        });

        // ------------------ Toggle holiday (admin action) ------------------
        function toggleHolidayByEmail(email) {
            if (!isAdminLoggedIn) { showMessage('Admin required to mark holiday', 'error'); return; }
            const idx = facultyData.findIndex(f => f.email === email);
            if (idx === -1) return showMessage('Faculty not found', 'error');
            facultyData[idx].holiday = !facultyData[idx].holiday;
            persistData();
            showMessage(`${facultyData[idx].name} is now ${facultyData[idx].holiday ? 'marked On Leave' : 'marked Available'}`, 'success');
            refreshAll();
        }

        // ------------------ Search / filter handlers ------------------
        const onFilterChangeDebounced = debounce(() => {
            const now = getNow();
            const filtered = getFilteredFacultyList(searchBar.value);
            displayFaculty(filtered, now);
            updateStats(now);
        }, 160);

        searchBar.addEventListener('input', onFilterChangeDebounced);
        buildingFilter.addEventListener('change', onFilterChangeDebounced);
        departmentFilter.addEventListener('change', onFilterChangeDebounced);
        floorFilter.addEventListener('change', onFilterChangeDebounced);

        mapBuildingFilter.addEventListener('change', updateMap);
        mapFloorFilter.addEventListener('change', updateMap);

        clearBtn.addEventListener('click', () => {
            searchBar.value = '';
            buildingFilter.value = 'all';
            departmentFilter.value = 'all';
            floorFilter.value = 'all';
            mapBuildingFilter.value = '';
            mapFloorFilter.value = '';
            updateMap();
            onFilterChangeDebounced();
        });

        exportBtn.addEventListener('click', exportVisibleToExcel);

        directionsModal.addEventListener('click', (e) => { if (e.target === directionsModal) closeDirectionsModal(); });
        window.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeDirectionsModal(); });

        // ------------------ Stats update ------------------
        function updateStats(now = getNow()) {
            let available = 0, teaching = 0, holiday = 0;
            for (const f of facultyData) {
                if (f.holiday) { holiday++; continue; }
                const s = getFacultyStatusAt(f, now);
                if (s.status === 'available') available++;
                if (s.status === 'teaching') teaching++;
            }
            totalCountEl.textContent = facultyData.length;
            availableCountEl.textContent = available;
            teachingCountEl.textContent = teaching;
            holidayCountEl.textContent = holiday;
        }

        // ------------------ Current time tick and refresh ------------------
        function tick() {
            const now = getNow();
            currentTimeEl.textContent = formatNowForDisplay(now);
        }

        function refreshAll() {
            const now = getNow();
            const filtered = getFilteredFacultyList(searchBar.value);
            displayFaculty(filtered, now);
            updateStats(now);
            updateMap();
            tick();
        }

        // ------------------ Persistence helpers ------------------
        function persistData() {
            try {
                localStorage.setItem('facultyData_v1', JSON.stringify(facultyData));
            } catch (e) {
                console.warn('Could not persist data to localStorage', e);
            }
        }

        function setAdminState(loggedIn) {
            isAdminLoggedIn = !!loggedIn;
            localStorage.setItem('faculty_admin_logged_in', isAdminLoggedIn ? 'true' : 'false');
            if (isAdminLoggedIn) {
                uploadSection.classList.add('visible');
                uploadSection.setAttribute('aria-hidden','false');
                adminBtn.classList.add('logged-in');
                adminBtn.textContent = '‚úì Admin';
            } else {
                uploadSection.classList.remove('visible');
                uploadSection.setAttribute('aria-hidden','true');
                adminBtn.classList.remove('logged-in');
                adminBtn.textContent = 'üîê Admin';
            }
            // re-render to show/hide admin buttons on cards
            refreshAll();
        }

        // ------------------ Admin modal handlers ------------------
        function openAdminModal() {
            adminModal.classList.add('active');
            adminModal.setAttribute('aria-hidden','false');
            adminUser.focus();
        }
        function closeAdminModal() {
            adminModal.classList.remove('active');
            adminModal.setAttribute('aria-hidden','true');
            adminUser.value = ''; adminPass.value = '';
        }

        adminBtn.addEventListener('click', () => {
            if (isAdminLoggedIn) {
                // toggle off or open admin panel? here we open admin controls
                if (uploadSection.classList.contains('visible')) {
                    // already visible; allow logout button to handle
                    showMessage('Admin mode active', 'success');
                } else {
                    setAdminState(true);
                }
            } else {
                openAdminModal();
            }
        });

        adminLoginBtn.addEventListener('click', () => {
            const u = adminUser.value.trim();
            const p = adminPass.value;
            if (u === ADMIN_USERNAME && p === ADMIN_PASSWORD) {
                setAdminState(true);
                closeAdminModal();
                showMessage('Logged in as Admin', 'success');
            } else {
                showMessage('Invalid admin credentials', 'error');
            }
        });

        // Enter triggers login
        adminPass.addEventListener('keypress', (e) => { if (e.key === 'Enter') adminLoginBtn.click(); });

        logoutBtn.addEventListener('click', () => { setAdminState(false); showMessage('Admin logged out', 'success'); });

        // ------------------ Upload area handlers (drag & drop + file input) ------------------
        uploadArea.addEventListener('click', () => fileInput.click());
        chooseFileBtn.addEventListener('click', () => fileInput.click());

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const file = e.dataTransfer.files && e.dataTransfer.files[0];
            if (file) handleFile(file);
        });
        fileInput.addEventListener('change', (e) => { const file = e.target.files && e.target.files[0]; if (file) handleFile(file); });

        downloadTemplateBtn.addEventListener('click', () => {
            const template = [
                { Name: 'Dr. John Doe', Building: 'ABB1', Floor: '2', Cabin: '201', Department: 'Computer Science', Email: 'john.doe@jiit.ac.in', Phone: '9876543210', OfficeHours: 'Mon-Fri 10AM-5PM', Holiday: 'No' },
                { Name: 'Prof. Jane Smith', Building: 'ABB2', Floor: '3', Cabin: '305', Department: 'Electronics', Email: 'jane.smith@jiit.ac.in', Phone: '9876543211', OfficeHours: 'Tue-Thu 2PM-6PM', Holiday: 'No' }
            ];
            const ws = XLSX.utils.json_to_sheet(template);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Template');
            XLSX.writeFile(wb, 'faculty_template.xlsx');
        });

        function handleFile(file) {
            if (!isAdminLoggedIn) { showMessage('You must be an admin to upload', 'error'); return; }
            const reader = new FileReader();
            reader.onload = (ev) => {
                try {
                    const data = new Uint8Array(ev.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { defval: '' });
                    processExcelData(jsonData);
                } catch (err) {
                    showMessage('Error reading file. Ensure it is a valid Excel file.', 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function processExcelData(rows) {
            if (!rows || rows.length === 0) { showMessage('Excel file is empty', 'error'); return; }
            const cleaned = rows.map(r => ({
                name: r.Name || r.name || '',
                building: r.Building || r.building || '',
                cabin: r.Cabin || r.cabin || '',
                floor: r.Floor || r.floor || '',
                department: r.Department || r.department || '',
                email: (r.Email || r.email || '').toString().trim(),
                phone: (r.Phone || r.phone || '').toString(),
                officeHours: r.OfficeHours || r.officeHours || '',
                holiday: String(r.Holiday || r.holiday || '').toLowerCase() === 'yes' || String(r.Holiday || r.holiday || '').toLowerCase() === 'true'
            })).filter(f => f.name && f.email);

            if (cleaned.length === 0) { showMessage('No valid rows in the uploaded file', 'error'); return; }

            // Replace entire dataset with uploaded one (admin action)
            facultyData = cleaned.map(f => {
                // preserve any existing timetable if present by matching email (optional)
                const existing = (Array.isArray(window.facultyData) ? window.facultyData : []).find(x => x.email === f.email);
                return {
                    ...existing, // keep existing timetable if any
                    ...f
                };
            });

            persistData();
            updateFilters();
            refreshAll();
            showMessage(`Loaded ${facultyData.length} faculty rows`, 'success');
        }

        // ------------------ Toggle holiday and persist are implemented above ------------------

        // ------------------ Initialization ------------------
        updateFilters();
        setAdminState(isAdminLoggedIn);
        refreshAll();

        // periodic refresh
        setInterval(refreshAll, 30000);
        setInterval(tick, 1000);

        // Accessibility small helpers
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                adminModal.classList.remove('active');
                directionsModal.classList.remove('active');
            }
        });
    </script>
</body>
</html>
